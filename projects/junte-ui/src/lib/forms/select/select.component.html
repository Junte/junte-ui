<ng-template #emptyOptionsDefaultTemplate let-query="query">
  <jnt-icon [icon]="ui.icons.neutral"></jnt-icon>
</ng-template>

<ng-template #optionDefaultTemplate let-icon="icon" let-label="label">
  <jnt-stack [orientation]="ui.orientation.horizontal"
             [gutter]="ui.gutter.small"
             [align]="ui.align.center">
    <jnt-icon *ngIf="icon" [icon]="icon"></jnt-icon>
    <div>{{label}}</div>
  </jnt-stack>
</ng-template>

<jnt-stack data-select [orientation]="ui.orientation.horizontal"
           [gutter]="ui.gutter.tiny" [align]="ui.align.center"
           tabindex="0">
  <div *ngIf="!!label" data-label>{{label}}</div>
  <jnt-icon *ngIf="!!icon && !label" [icon]="icon"></jnt-icon>
  <ul #selectedList>
    <ng-container *ngIf="selected.length">
      <li *ngFor="let key of selected" (click)="mode == ui.select.mode.single ? (opened ? close() : open()) : null">
        <ng-template #noOptionTemplate>
          <div data-empty></div>
        </ng-template>
        <div *ngIf="(key | getOption:options:changes.selected:changes.options) as o;else noOptionTemplate">
          <ng-container *ngTemplateOutlet="!!optionTemplate ? optionTemplate
            : optionDefaultTemplate;context: {icon: o.icon, label: o.label, value: o.value, selected: true}">
          </ng-container>
        </div>
        <button data-close type="button" (click)="remove(key)">
          <jnt-icon [icon]="ui.icons.closeSmall"></jnt-icon>
        </button>
      </li>
    </ng-container>

    <li data-query [formGroup]="form" (click)="opened ? close() : open()">
      <input #queryInput [placeholder]="mode != ui.select.mode.multiple || !selected.length ? placeholder : ''"
             formControlName="query">
    </li>
  </ul>
  <div data-loading *ngIf="state === ui.state.loading">
    <jnt-spinner data-spinner></jnt-spinner>
  </div>
  <button data-toggle type="button" (click)="opened ? close() : open()">
    <jnt-icon [icon]="opened ? ui.icons.selectOpen : ui.icons.selectClose"></jnt-icon>
  </button>
</jnt-stack>

<ng-template #optionsTemplate>
  <div data-options *ngIf="opened" [attr.data-loading]="loading">
    <ng-template #noOptionsTemplate>
      <div data-skeleton>
        <jnt-skeleton *ngIf="loading; else optionsNotFoundTemplate"
                      [type]="ui.skeleton.type.text" [lines]="5"></jnt-skeleton>
      </div>
      <ng-template #optionsNotFoundTemplate>
        <div data-empty-options>
          <ng-container *ngTemplateOutlet="!!emptyOptionsTemplate ? emptyOptionsTemplate
              : emptyOptionsDefaultTemplate;context: {query: queryControl.value, close: close.bind(this)}">
          </ng-container>
        </div>
      </ng-template>
    </ng-template>
    <ng-container *ngIf="((!!queryControl.value ? options.found : options.persisted)
    | getOptions:changes.selected:changes.options) as options">
      <ng-container *ngIf="options.length;else noOptionsTemplate">
        <div data-loading *ngIf="loading">
          <jnt-spinner data-spinner></jnt-spinner>
        </div>
        <jnt-stack [align]="ui.align.stretch">
          <div data-options-header *ngIf="!!optionsHeaderTemplate">
            <ng-container *ngTemplateOutlet="optionsHeaderTemplate;context: {close: close.bind(this)}"></ng-container>
          </div>
          <ul [attr.data-windows]="device.platform.windows">
            <li *ngFor="let o of options;trackBy:trackOption"
                [attr.data-selected]="selected | includes:o.key"
                (click)="toggle(o)">
              <ng-container *ngTemplateOutlet="!!optionTemplate ? optionTemplate
              : optionDefaultTemplate;context: {icon: o.icon, label: o.label, value: o.value}">
              </ng-container>
            </li>
          </ul>
        </jnt-stack>
      </ng-container>
    </ng-container>
  </div>
</ng-template>

<ng-container *jntFor="ui.breakpoint.mobile">
  <ng-container *ngTemplateOutlet="optionsTemplate"></ng-container>
</ng-container>

