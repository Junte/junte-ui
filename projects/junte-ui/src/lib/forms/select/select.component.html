<ng-template #emptyOptionsDefaultTemplate let-query="query">
  <jnt-icon [icon]="ui.icons.neutral"></jnt-icon>
</ng-template>

<ng-template #optionDefaultTemplate let-query="query" let-icon="icon" let-label="label">
  <jnt-stack [orientation]="ui.orientation.horizontal"
             [gutter]="ui.gutter.small"
             [align]="ui.flex.align.center">
    <jnt-icon *ngIf="icon" [icon]="icon"></jnt-icon>
    <div>{{label}}</div>
  </jnt-stack>
</ng-template>

<div data-select tabindex="0" [attr.data-has-icon]="!!icon">
  <div *ngIf="label" data-label>{{label}}</div>
  <jnt-icon *ngIf="!!icon && !label" [icon]="icon"></jnt-icon>
  <ul #selectedList>
    <ng-container *ngIf="selected.length">
      <li *ngFor="let key of selected" (click)="mode == selectMode.single ? opened = true : null">
        <ng-template #noOptionTemplate>
          <div data-empty></div>
        </ng-template>
        <div *ngIf="(key | getOption:options:changes.selected:changes.options) as option;else noOptionTemplate">
          <ng-container *ngTemplateOutlet="!!optionTemplate ? optionTemplate
            : optionDefaultTemplate;context: option">
          </ng-container>
        </div>
        <button data-close type="button" (click)="remove(key)">
          <jnt-icon [icon]="ui.icons.close"></jnt-icon>
        </button>
      </li>
    </ng-container>

    <li [formGroup]="form" (click)="opened = true" data-query>
      <input #queryInput [placeholder]="mode != selectMode.multiple || !selected.length ? placeholder : ''"
             formControlName="query">
    </li>
  </ul>
  <button data-toggle type="button" (click)="opened = !opened">
    <jnt-icon [icon]="opened ? ui.icons.chevronUp : ui.icons.chevronDown"></jnt-icon>
  </button>
</div>

<ng-template #optionsTemplate>
  <div data-options *ngIf="opened" [attr.data-loading]="loading">
    <ng-template #noOptionsTemplate>
      <div data-skeleton>
        <jnt-skeleton *ngIf="loading; else optionsNotFoundTemplate"
                      [type]="ui.layout.skeleton.type.text" [lines]="5"></jnt-skeleton>
      </div>
      <ng-template #optionsNotFoundTemplate>
        <div data-empty-options>
          <ng-container *ngTemplateOutlet="!!emptyOptionsTemplate ? emptyOptionsTemplate
              : emptyOptionsDefaultTemplate;context: {query: queryControl.value, close: close.bind(this)}">
          </ng-container>
        </div>
      </ng-template>
    </ng-template>
    <ng-container *ngIf="((!!queryControl.value ? options.found : options.persisted)
    | getOptions:changes.selected:changes.options) as options">
      <ng-container *ngIf="options.length;else noOptionsTemplate">
        <div data-loading *ngIf="loading">
          <jnt-spinner></jnt-spinner>
        </div>
        <jnt-stack [align]="ui.flex.align.stretch">
          <div data-options-header *ngIf="!!optionsHeaderTemplate">
            <ng-container *ngTemplateOutlet="optionsHeaderTemplate;context: {close: close.bind(this)}"></ng-container>
          </div>
          <ul>
            <li *ngFor="let o of options;trackBy:trackOption"
                [attr.data-selected]="selected | includes:o.key"
                (click)="toggle(o)">
              <ng-container *ngTemplateOutlet="!!optionTemplate ? optionTemplate
              : optionDefaultTemplate;context: o">
              </ng-container>
            </li>
          </ul>
        </jnt-stack>
      </ng-container>
    </ng-container>
  </div>
</ng-template>

<ng-container *ngIf="mobile">
  <ng-container *ngTemplateOutlet="optionsTemplate"></ng-container>
</ng-container>

