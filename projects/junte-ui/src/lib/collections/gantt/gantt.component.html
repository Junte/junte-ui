<ng-template #titleDefaultTemplate let-title="title">
  {{title}}
</ng-template>
<ng-template #lineTitleDefaultTemplate let-title="title">
  {{title}}
</ng-template>
<ng-template #ganttYearTemplate>
  <table border="0" cellpadding="5" [cellSpacing]="0">

    <thead>
    <tr>
      <td data-gutter></td>
      <td data-empty>
        <ng-container *ngIf="toolsTemplate">
          <ng-container *ngTemplateOutlet="toolsTemplate"></ng-container>
        </ng-container>
      </td>
      <td data-controls [attr.colspan]="12">
        <div data-month>
          <button data-arrow (click)="current = subYears(current, 1)">
            <jnt-icon [icon]="ui.icons.chevronLeft"></jnt-icon>
          </button>
          <div>
            {{current | dfnsFormat: 'yyyy'}}
          </div>
          <button data-arrow (click)="current = addYears(current, 1)">
            <jnt-icon [icon]="ui.icons.chevronRight"></jnt-icon>
          </button>
        </div>
      </td>
    </tr>

    <tr data-timeline>
      <td data-gutter></td>
      <td>
        <ng-container
          *ngTemplateOutlet="!!titleTemplate ? titleTemplate : titleDefaultTemplate;context: this"></ng-container>
      </td>
      <td data-day *ngFor="let month of (current | dfnsStartOfYear | betweenMonths:(current | dfnsEndOfYear))"
          [attr.current]="month">
        {{month | monthName}}
      </td>
    </tr>
    </thead>
    <tbody>
    <ng-template #noDataTemplate>
      <tr data-nodata>
        <td [attr.colspan]="(current | dfnsGetDaysInMonth) + 1">
          <jnt-icon [icon]="ui.icons.neutral"></jnt-icon>
        </td>
      </tr>
    </ng-template>
    <ng-template #skeletonTemplate>
      <ng-container *ngIf="loading; else noDataTemplate">
        <tr data-loading>
          <td [attr.colspan]="(current | dfnsGetDaysInMonth) + 2">
            <jnt-skeleton [type]="ui.skeleton.type.text" [lines]="8"></jnt-skeleton>
          </td>
        </tr>
      </ng-container>
    </ng-template>

    <ng-container *ngIf="!!lines?.length; else skeletonTemplate">
      <ng-container *ngFor="let line of lines">

        <tr *ngFor="let period of line.periods; let i = index">

          <ng-container *ngIf="i === 0">
            <td data-gutter [attr.rowspan]="line.periods.length"></td>
            <td data-title [attr.rowspan]="line.periods.length">
              <ng-container
                *ngTemplateOutlet="line.titleTemplate || lineTitleDefaultTemplate; context: {title: line.title}"></ng-container>
            </td>
          </ng-container>

          <ng-template #periodTemplate let-from="from" let-to="to" let-start="start" let-end="end" let-period="period">
            <td *ngFor="let d of start | betweenMonths:from | pop"></td>
            <td [attr.colspan]="(from | betweenMonths:to).length">
              <ng-container *ngIf="!((period.to | dfnsIsBefore:start) || (period.from | dfnsIsAfter:end))">
                <ng-container  *ngTemplateOutlet="period.indicatorYearTemplate;
                  context: {period: period, current: current, today: today}">
                </ng-container>
              </ng-container>
            </td>
            <td *ngFor="let d of to | betweenMonths:end | pop"></td>
          </ng-template>

          <ng-container *ngTemplateOutlet="periodTemplate;context:
            {start: current | dfnsStartOfYear ,
              end: current | dfnsEndOfYear,
              period: period,
              current: current,
              from: [[period.from, current | dfnsStartOfYear] | dfnsMax, current | dfnsEndOfYear] | dfnsMin,
              to: [[period.to, current | dfnsEndOfYear] | dfnsMin, current | dfnsStartOfYear] | dfnsMax}"></ng-container>

        </tr>
      </ng-container>
    </ng-container>

    </tbody>
  </table>
</ng-template>

<ng-container *ngIf="type === types.month; else ganttYearTemplate">
  <table border="0" cellpadding="5" [cellSpacing]="0">
    <thead>
    <tr>
      <td data-gutter></td>
      <td data-empty>
        <ng-container *ngIf="toolsTemplate">
          <ng-container *ngTemplateOutlet="toolsTemplate"></ng-container>
        </ng-container>
      </td>
      <td data-controls [attr.colspan]="(current | dfnsGetDaysInMonth)">
        <div data-month>
          <button data-arrow (click)="current = subMonths(current, 1)">
            <jnt-icon [icon]="ui.icons.chevronLeft"></jnt-icon>
          </button>
          <div>
            {{current | dfnsFormat: 'MMMM'}}, {{current | dfnsFormat: 'yyyy'}}
          </div>
          <button data-arrow (click)="current = addMonths(current, 1)">
            <jnt-icon [icon]="ui.icons.chevronRight"></jnt-icon>
          </button>
        </div>
      </td>
    </tr>

    <tr data-timeline>
      <td data-gutter></td>
      <td>
        <ng-container
          *ngTemplateOutlet="!!titleTemplate ? titleTemplate : titleDefaultTemplate;context: this"></ng-container>
      </td>
      <td data-day *ngFor="let day of (current | datesInMonth)"
          [attr.data-current]="day | dfnsIsToday"
          [attr.data-weekend]="day | dfnsIsWeekend">
        {{day | dfnsGetDate}}
      </td>
    </tr>
    </thead>
    <tbody>
    <ng-template #noDataTemplate>
      <tr data-nodata>
        <td [attr.colspan]="(current | dfnsGetDaysInMonth) + 1">
          <jnt-icon [icon]="ui.icons.neutral"></jnt-icon>
        </td>
      </tr>
    </ng-template>
    <ng-template #skeletonTemplate>
      <ng-container *ngIf="loading; else noDataTemplate">
        <tr data-loading>
          <td [attr.colspan]="(current | dfnsGetDaysInMonth) + 2">
            <jnt-skeleton [type]="ui.skeleton.type.text" [lines]="8"></jnt-skeleton>
          </td>
        </tr>
      </ng-container>
    </ng-template>

    <ng-container *ngIf="!!lines?.length; else skeletonTemplate">
      <ng-container *ngFor="let line of lines">

        <tr *ngFor="let period of line.periods; let i = index">

          <ng-container *ngIf="i === 0">
            <td data-gutter [attr.rowspan]="line.periods.length"></td>
            <td data-title [attr.rowspan]="line.periods.length">
              <ng-container
                *ngTemplateOutlet="line.titleTemplate || lineTitleDefaultTemplate; context: {title: line.title}"></ng-container>
            </td>
          </ng-container>

          <ng-template #periodTemplate let-from="from" let-to="to" let-start="start" let-end="end" let-period="period">
            <td *ngFor="let d of start | betweenDays:from | pop"></td>
              <td [attr.colspan]="(from | betweenDays:to).length">
                <ng-container *ngIf="!((period.to | dfnsIsBefore:start) || (period.from | dfnsIsAfter:end))">
                  <ng-container  *ngTemplateOutlet="period.indicatorMonthTemplate;
                  context: {period: period, current: current, today: today}">
                  </ng-container>
                </ng-container>
              </td>
            <td *ngFor="let d of to | betweenDays:end | pop"></td>
          </ng-template>

          <ng-container *ngTemplateOutlet="periodTemplate;context:
            {start: current | dfnsStartOfMonth,
              end: current | dfnsEndOfMonth,
              period: period,
              current: current,
              from: [[period.from, current | dfnsStartOfMonth] | dfnsMax, current | dfnsEndOfMonth] | dfnsMin,
              to: [[period.to, current | dfnsEndOfMonth] | dfnsMin, current | dfnsStartOfMonth] | dfnsMax}"></ng-container>

        </tr>
      </ng-container>

    </ng-container>
    </tbody>
  </table>
</ng-container>



